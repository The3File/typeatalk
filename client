#!/usr/bin/env bash

get_size(){ read -r LINES COLUMNS < <(stty size); }
send(){ echo -e "\r\e[K$u> $chat" >&3; }

menu(){
	get_size
   printf '\e[H\e[J\e[%sH' "$LINES"
   while IFS= read -rsn1 -p $'\r\e[K'"$u [normal]" char; do
      case $char in
			i) char=""; compose ;;
			q) exit 0
      esac
   done
}

compose(){
   while IFS= read -rsn1 -p $'\r\e[K'"$u [insert]: $chat" char; do
      printf '\e[%sH' "$LINES"
      case "$char" in
         $'\177') [[ $chat ]] && { echo "delete" >&3; chat="${chat%?}"; } ;;
         $'\033') send; echo esc >&3; break ;;
         $'\015'|'') send; echo "enter" >&3; chat="" ;;
         " "|*) chat+="$char" ;;
      esac
		send
   done
}

main(){
	trap 'exec 3>&-' EXIT
   trap "printf '\e[m\e[2J\e[H\e[?25h'" EXIT
   trap "get_size" WINCH

	server_fifo=s_fifo
	server_out=c_fifo

	exec 3<>$server_fifo
   [[ $1 ]] && u="$1" || read -p "Choose a username: " u
   echo -e "\n\r\e[K$u connected\n" >&3
   echo -e "useradd" >&3
   menu
}

main "$@"
