#!/usr/bin/env bash

server_fifo="s_fifo"
[[ -e $server_fifo ]] && rm $server_fifo
mkfifo $server_fifo
chat_fifo="c_fifo"
[[ -e $chat_fifo ]] && rm $chat_fifo
mkfifo $chat_fifo

((current_line=1,max_lines=LINES-2))

enter_func(){
	line_done+=("$line"); char=""
	printf '\e[H\e[J' >&3
	printf '%s\n' "${line_done[@]}" >&3
}

exec 3<>$chat_fifo

while read -r char; do
	case $char in
		enter|useradd) enter_func ;;
		delete) line="${line%?}" ;;
		esc) ;;
		" "|*) line+="$char"
	esac
	printf '\e[s\e[%sH\n%s\e[u' "${#line_done[@]}" "$line" >&3
done < $server_fifo

printf '\n%s\n' "pipe closed"
